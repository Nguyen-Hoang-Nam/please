#!/bin/bash

COMMAND_TYPE=''
COMMAND_FILE=''

command_exec='command_not_found'
is_found=false
config_path='please.json'
match_list=()

help() {
	echo "Usage: please run|install|clean|build|deploy|test file-name" >&2
}

command_not_found() {
    echo "Sorry, I can't find it" >&2
}

config_not_found() {
    echo "Sorry, please create please.json file to start" >&2
}

multiple_match() {
    echo "Match multiple time" >&2
}

trim_double_quote() {
    local text=$1
    text="${text/#\"}"
    text="${text/%\"}"

    echo text
}

trim_single_quote() {
    local text=$1
    text="${text/#\'}"
    text="${text/%\'}"

    echo text
}

find_configuration_file() {
	local path
    path="$(pwd)"
	while [[ "${path}" != "" && ! -e "$path/$1" ]]; do
		path="${path%/*}"
	done

	if [[ "${path}" == "" ]]; then
		config_not_found
        exit 1
	fi

	config_path=$path
}

configure_local() {
	command_exec=$(echo "$config" | jq -r ".${COMMAND_TYPE}")
	if [[ $command_exec = null ]]; then
		command_exec='command_not_found'
	else
		is_found=true
	fi
}

get_highest_priority() {
	local max_priority=1
	for match in "${match_list[@]}"; do
		match_trim=$(sed -e "s/^'//" -e "s/'$//" <<<"$match")
		priority=$(jq '.priority' <<<$match_trim)
		if [[ $priority != null ]]; then
			if [[ $max_priority -lt $priority ]]; then
				max_priority=$priority
			fi
		fi
	done

	echo $max_priority
}

configure_global() {
	while read project; do
		project_jq() {
			echo $project | jq $1
		}

		directory=$(project_jq '.directory')
		if [[ $directory != null ]] && [[ $directory = "\"${PWD##*/}\"" ]]; then
			match_list+=("'$project'")
			continue
		fi

		files=$(project_jq '.files')
		if [[ $files = null ]]; then continue; fi

		list_files=$(ls)
		while read file; do
			file_jq() {
				echo $file | jq $1
			}

			file_name=$(file_jq '.name')
			if [[ $file_name = null ]]; then continue; fi

			file_name_trim=$(sed -e 's/^"//' -e 's/"$//' <<<"$file_name")
			grep -q $file_name_trim <<<$list_files
			if [[ $? != 0 ]]; then continue; fi

			file_match=$(file_jq '.match')
			if [[ $file_match = null ]]; then
				match_list+=("'$project'")
				continue
			fi

			# Support regex file name
			file_match_trim=$(sed -e 's/^"//' -e 's/"$//' <<<"$file_match")
			cat $file_name_trim | grep -q $file_match_trim
			if [[ $? = 0 ]]; then
				match_list+=("'$project'")
			fi
		done < <(echo $files | jq -c '.[]')
	done < <(echo $config | jq -c '.projects | .[]')

	max_priority=$(get_highest_priority)

	max_match=""
	count_max_match=0
	for match in "${match_list[@]}"; do
		match_trim=$(sed -e "s/^'//" -e "s/'$//" <<<"$match")
		priority=$(jq '.priority' <<<$match_trim)
		if [[ $priority == null ]]; then
			if [[ $max_priority = 1 ]]; then
				max_match=$match
				((count_max_match++))
			fi
		else
			if [[ $max_priority = $priority ]]; then
				max_match=$match
				((count_max_match++))
			fi
		fi

		if [[ $count_max_match = 2 ]]; then
			multiple_match
			exit 1
		fi
	done

	if [[ $max_match != "" ]]; then
		max_match_trim=$(sed -e "s/^'//" -e "s/'$//" <<<"$max_match")
		command_exec=$(echo "$max_match_trim" | jq -r ".${COMMAND_TYPE}")
        if [[ $command_exec = null ]]; then
            command_exec='command_not_found'
        else
            is_found=true
        fi
	fi
}

read_configuration_file() {
    if [[ "${COMMAND_FILE}" == '' ]]; then COMMAND_FILE='please.json'; fi
	find_configuration_file "${COMMAND_FILE}"
	if (( $? != 0 )); then exit 1; fi

	config=$(cat "$config_path/${COMMAND_FILE}")
	if [[ $(pwd) = $config_path ]]; then configure_local; fi

	if [[ $is_found = false ]]; then
		is_global=$(echo "$config" | jq 'has("projects")')
		if [[ $is_global = true ]]; then
			configure_global
		fi
	fi

}

case "$1" in
run)
    COMMAND_TYPE='run'
    COMMAND_FILE="$2"
	;;

install)
    COMMAND_TYPE='install'
    COMMAND_FILE="$2"
	;;

clean)
    COMMAND_TYPE='clean'
    COMMAND_FILE="$2"
	;;

build)
    COMMAND_TYPE='build'
    COMMAND_FILE="$2"
	;;

deploy)
    COMMAND_TYPE='deploy'
    COMMAND_FILE="$2"
	;;

test)
    COMMAND_TYPE='test'
    COMMAND_FILE="$2"
    ;;

*)
	help
    exit 1
	;;
esac

read_configuration_file
eval $command_exec
